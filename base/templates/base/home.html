{% extends 'main.html' %}

{% block content %}

{% load static %}

<link rel="stylesheet" href="{% static 'styles/home.css' %}">

<div class="main-container">
    <div class="announcement-container">
        <h2 class="announcement-title">ANNOUNCEMENTS</h2>
        {% if last_announcement %}
        <div>
            <div class="ann-date">
                <span>Date Posted:</span>
                {{ last_announcement.date }}
            </div>
            <div>
                <img src="{{ last_announcement.photo.url }}" class="announcement-photo" alt="No Announcement Available">
            </div>
        </div>
        {% else %}
        <p>No announcements available.</p>
        {% endif %}
    </div>

    <div class="env-container">
        <h3 class="env-title">PALTOC HC MONITORING</h3>
        <div class="view-charts">
            <a id="view-charts-link" href="{% url 'graph_data' %}">View Charts<i class="fa-solid fa-arrow-right-long"></i></a>
        </div>
        
        <!-- Last update time -->
        <div class="last-update">
            <p>Last Update: <span id="last_update">Loading...</span></p>
        </div>
        
        <div class="sensor-container">
            <div class="card temp">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">Temperature</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading temp-reading">27</span><span> °C</span>
                            </div>
                        </div>
                        <div class="card-icon temp">
                            <i class="fa-solid fa-thermometer-three-quarters"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card heat-index">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">Heat Index</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading heat-index-reading">30</span><span> °C</span>
                            </div>
                        </div>
                        <div class="card-icon heat-index">
                            <i class="fa-regular fa-sun"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card humidity">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">Humidity</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading humidity-reading">23</span><span> %</span>
                            </div>
                        </div>
                        <div class="card-icon humidity">
                            <i class="fa-solid fa-droplet"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card co2">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">Air Gases</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading air-gases-reading">800</span><span> ppm</span>
                            </div>
                        </div>
                        <div class="card-icon co2">
                            <i class="fa-solid fa-wind"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card pm1">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">PM1</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading pm1-reading">10</span><span>µg/m³</span>
                            </div>
                        </div>
                        <div class="card-icon pm1">
                            <i class="fa-solid fa-virus"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card pm25">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">PM2.5</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading pm2_5-reading">15</span><span>µg/m³</span>
                            </div>
                        </div>
                        <div class="card-icon pm25">
                            <i class="fa-brands solid fa-cloudversify"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card pm10">
                <div class="card-body">
                    <div class="card-row">
                        <div class="card-content">
                            <div class="label">PM10</div>
                            <div class="sensor-reading">
                                <span class="sensor-reading pm10-reading">20</span><span>µg/m³</span>
                            </div>
                        </div>
                        <div class="card-icon pm10">
                            <i class="fa-solid fa-smog"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for updating sensor data -->
<script>
    function updateSensorData() {
        fetch("{% url 'latest_envi_data' %}")
        .then(response => response.json())
        .then(data => {
            document.getElementById('last_update').textContent = data.created_at;
            document.querySelector('.temp-reading').textContent = data.temp;
            document.querySelector('.heat-index-reading').textContent = data.heat_index;
            document.querySelector('.humidity-reading').textContent = data.humidity;
            document.querySelector('.air-gases-reading').textContent = data.air_gases;
            document.querySelector('.pm1-reading').textContent = data.pm1;
            document.querySelector('.pm2_5-reading').textContent = data.pm2_5;
            document.querySelector('.pm10-reading').textContent = data.pm10;

            // Extract the year, month, and day from the created_at date
            const createdAt = new Date(data.created_at);
            const year = createdAt.getFullYear();
            const month = String(createdAt.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const day = String(createdAt.getDate()).padStart(2, '0');

            // Update the href attribute of the "View Charts" link
            const viewChartsLink = document.getElementById('view-charts-link');
            viewChartsLink.href = `{% url 'graph_data' %}${year}/${month}/${day}/`;
        })
        .catch(error => {
            console.error('Error fetching sensor data:', error);
        });
    }

    // Call updateSensorData function initially
    updateSensorData();

    // Update sensor data every 5 seconds
    setInterval(updateSensorData, 5000);
</script>

{% endblock content %}
